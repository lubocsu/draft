从遗留技术栈升级里，我学到的八件事
===

几周前，当我使用 Mifa 主题刷新我的博客时，我发现了一件不得了的事情：我的博客使用的 Python 版本是 2.7，而不是我预期的 3.5。并且我用的 Django 版本是 1.9，它是 2015 年的版本。这些让我意识到，如果我再不做点什么，我的博客可能就维护不了了。

Django 已经 2.0 了，Python 2.7 即将（好多年了）成为过去式了。

于是，我决定要去升级我的博客的技术栈了，理想中的步骤很简单：

1. 升级核心框架
2. 迁移应用代码
3. 迁移数据库

只是在这个过程中，遇到一系列的坑。真实的步骤如下所示：

1. 创建全新的环境
2. 使用线上的数据进行测试
3. 全程使用版本管理控制，方便回滚
4. 优先升级次要组件的版本
5. 一步步升级核心框架
6. 必要时，自己编写组件代码 
7. 清理掉不需要的代码、文件
8. 上线前使用线上的环境进行预部署

1. 搭建一个新的环境
---

virtualenv

2. 使用线上的数据进行测试
---

早期的数据库不能使用，于是我在 AWS S3 备份了的数据库，

3. 全程使用版本管理控制，方便回滚
---

是的，即使你更新了个小依赖，也要确保使用了版本管理。因为

你可能更新了 A,B,C 依赖，同时更新了某个

4. 优先升级次要组件的版本
---

过去我一般不会采用固定依赖版本的方式来运行部署，如 Ruby 中的 Gemfile，Node.js 中的 Yarn.lock，Python 中采用的方式是：

```
django==1.10.7
Mezzanine==4.2.3
bleach==1.5
djangorestframework==3.7.7
django-uuslug
django-cors-headers
djangorestframework-jwt
django-widget-tweaks==1.4.1
markdown==2.6.11
```

如上所见，我只会在重要的组件中，采用 fix 的版本号，主要是为了方便升级。

5. 一步步升级核心框架
---

起先我直接改 Django 改成了 2.0.1 版本，发现一系列的不兼容，于是只能转到 1.10.7 。

然而，从 1.9.6 到 1.10.7 算是一个大的升级，为 2.0 移除了一系列不兼容的 API，如旧的 ``urls.py`` 全部升级

6. 必要时，自己编写组件代码 
---

默认使用的 markdown 编辑器，``mezzanine_pagedown`` 中的 ``urls.py`` 使用的 pattern 已经被抛弃了。而这个 repo 几乎已经陷入了不维护的状态，于是我只得引入这个库到我的项目中，然后自己去修复这些问题。

7. 清理掉不需要的代码、文件
---

 - 静态文件库
 - 不使用的代码

早期使用 ``python manage.py collectstatic`` 的时候，留下了不同版本的静态文件，如早期的 jQuery 1.4.2、jquery-1.7.1.min.js、jquery-1.7.2.min.js 等等。

因此，便直接删除了旧的静态文件

8. 上线前使用线上的环境进行预部署
---

我在我的服务器上获取最新的版本，创建了新的虚拟环境，然后测试：

``python manage.py runserver 8888``

代码看来似乎是好的，于是我更新了启动脚本里的 ``虚拟环境`` 的路径，并使用启动脚本来运行服务。结果，系统并没有启动起来——原因是少了 gunicorn。

Fabric，后来就变成了 Nginx + Gunicorn + Django，

可是我没有在 ``requirements.txt`` 中加油入 ``gunicorn`` 的依赖，

于是，我重新启动了服务，打开了 phodal.com，发现 500 了又。mdzz，

去看了看日志，发现线上使用了 memcached 作为数据缓存，但是没有添加在依赖中。

怪我咯。


